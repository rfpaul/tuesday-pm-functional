---
title: "Functionalizing NEON rasters"
author: "Robert Paul"
date: "June 21, 2016"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Objectives

1. Import a raster — A lidar canopy height model (lidar/Teak_lidarCHM.tif)
1. For the CHM, set values == 0 to NA (not trees)
1. Visualize density and plot vertical cutoff lines.
1. Classify the raster according to some distribution – low medium and tall trees. This could be done using a histogram potentially or we could just decide that <2m is generally grasses / understory, <6m small trees,and the rest are tall trees. A function could import the desired thresholds. Visualize histogram/density and plot vertical cutoff lines.
1. PLOT - layer the classified raster, add a legend for each “class” - legends are super tricky to simplifying this process with a function would be good.  see: http://neon-workwithdata.github.io/neon-data-institute-2016/R/classify-by-threshold-R/  for my take on forcing a legend outside of the plot area using par settings. You may have other better forms of magic to make this work well. :)
1. Export the plot figure to a pdf – publishable
1. Export the classified raster as a geotiff with NaFlagg = -9999 to an outputs folder.

## Objective 1: Import a Raster

### Load packages
```{r load-packages}
# Load up the packages we need to work with raster data
library(raster)
library(rgdal)
library(rhdf5)
```

### Grab raster
```{r grab-raster}
# Get canopy height model for Teakettle site
chm <- raster("../NEONdata/D17-California/TEAK/2013/lidar/TEAK_lidarCHM.tif")
```

## Objective 2: Set NA values
```{r insert-nas}
# 0 values are NA
chm[chm == 0] <- NA
```

## Objective 3: Visualize distribution of the input data
```{r original-raster-hist}
density(chm)
```

## Objective 4: Classify vegetation by height & show distribution
```{r reclass-trees}
# < 2m = grass, < 6m = small tree, > 6m = large tree
reclass <- c(0, 2, NA,
             2, 6, 1,
             6, 20, 2,
             20, 40, 3,
             40, 100, 4)
# Turn reclass vector into a matrix
reclass_mat <- matrix(reclass,
                      ncol=3,
                      byrow=TRUE)

# Reclassify!
chm_reclass <- reclassify(x = chm,
                          rcl = reclass_mat)
# Density plot!
density(chm)
# Break lines, except for the zero point
abline(v=reclass_mat[, 2][-1],
       col='red')
```

## Objective 5: Plot
```{r plot-reclass}
plot(chm_reclass,
     main = "Canopy Height Model\nReclassified by Height",
     # them's the breaks
     breaks=c(0, reclass_mat[,3][-1]),
     # them's the colors on the breaks
     col = c("goldenrod", "green", "blue", "violet"),
     # No box
     box = FALSE,
     # No axes
     axes = FALSE)
```

## Objective 6: Output to PDF
```{r pdf-output}
pdf(file = "../NEONdata/outputs/TEAK/TEAK_CHM_reclassified.pdf", width=6, height=7)
```

## Objective 7: Output to GeoTIFF
```{r geotiff-output}
writeRaster(x = chm_reclass,
            filename = "../NEONdata/outputs/TEAK/chm_reclass.tiff",
            format = "GTiff",
            overwrite = TRUE,
            NAflag = -9999)
```

### Save the environment information
```{r session-info-output}
sink(paste0(format(Sys.time(), "%Y-%m-%d_%H%M%S"),
                        "_sessionInfo.txt"))
sessionInfo()
sink()
```

